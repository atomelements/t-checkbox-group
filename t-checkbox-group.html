<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../t-checkbox/t-checkbox.html">
<!--
`t-checkbox-group` allows user to select multiple checkboxes from a set.
Check box list can be generated using 'data' string array or can be inserted using light dom

Data array example:

    <t-checkbox-group data='["First Choice","Second Choice","Third Choice","Fourth choice","fifth choice"]' selected-values='["Second Choice"]'>
    </t-checkbox-group>

Light DOM Example:

    <t-checkbox-group>
      <t-checkbox name="small" >Small</t-checkbox>
      <t-checkbox name="medium" >Medium</t-checkbox>
      <t-checkbox name="large" >Large</t-checkbox>
    </t-checkbox-group>

-->
<dom-module name="t-checkbox-group">
    <style is="custom-style">
    :host {
        position: relative;
        display: block;
        font-family: var(--primary-font-family);
    }
    
    :host([label]) label {
        color: var(--form-label-color);
        font-size: var(--form-label-size);
        display: block;
        margin-bottom: var(--form-label-margin);
    }
    
    :host::content t-checkbox {
        display: block;
    }
    
    :host([inline])::content t-checkbox {
        display: inline-block;
        margin-right: 20px;
        margin-bottom: 0;
    }
    
    :host([inline])::content t-checkbox:last-child {
        margin-right: 0;
    }
    
    iron-selector::content > t-checkbox {
        margin-top: var(--checkbox-item-margin);
        line-height: 1;
    }
    
    :host::content t-checkbox:first-child {
        margin-top: 0!important;
    }
    
    :host p {
        display: none;
    }
    /* line 12, D:\filter\less\date-input.less */
    
    :host.no-value p {
        display: block;
        position: absolute;
        top: 100%;
        padding: 0;
        margin: 0;
        left: 0;
        font-size: var(--error-text-size);
        color: var(--error-color);
    }
    
    :host([checkbox-right])::content t-checkbox #checkboxLabel {
        padding-left: 0;
        padding-right: 8px;
    }
    
    :host([checkbox-right])::content t-checkbox #checkboxContainer {
        order: 2;
    }
    
    @media (max-width: 600px) {
        :host([label]) label {
            font-size: var(--form-label-mobile-size);
            margin-bottom: var(--form-label-mobile-margin);
        }
    }
    </style>
    <template>
        <label hidden$="[[hideLabel]]">{{label}}</label>
        <p class="error">{{errorMessage}}</p>
        
        <template is="dom-repeat" items="[[data]]" as="item">
            <t-checkbox name$="[[_getValue(item)]]">[[_getLabel(item)]]</t-checkbox>
        </template>
    </template>
</dom-module>
<script>
Polymer({

    is: 't-checkbox-group',

    hostAttributes: {
        role: 'checkboxgroup'
    },

    listeners: {
        'checked-change': '_onCheckedChange'
    },
    properties: {

        /**
         * Json list based checkbox group.
         *
         * @attribute checked
         * @type boolean
         * @default false
         */
        data: {
            type: Array,
            value: function() {
                return [];
            },
            notify: true,
            observer: '_dataChanged',
            reflectToAttribute: true
        },

        /**
         * Name property
         */
        name: {
            type: String,
            value: '',
            reflectToAttribute: true
        },

        /**
         * Sets the label of the group leave empty for no label
         * @default ""
         */
        label: {
            type: String,
            value: "",
            reflectToAttribute: true
        },

        /**
         * Sets the boxes inline
         * @default false
         */
        inline: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
        },

        /**
         * Hides the label
         * @default false
         */
        hideLabel: {
            type: Boolean,
            value: false
        },

        /**
         * Gets the array of selected values
         * @attribute selected
         * @type Array
         * @default null
         */
        selectedValues: {
            type: Array,
            value: function() {
                return [];
            },
            observer: '_onSelectedItemChange',
            notify: true
        },

        required: {
            type: Boolean,
            value: false
        },

        /**
         * errorMsg is to put the error msg
         */
        errorMessage: {
            type: String,
            reflectToAttribute: true,
            value: 'Please select atleast one value!'
        },

        /**
         * Put the checkmark on the right.
         *
         * @attribute checked
         * @type boolean
         * @default false
         */
        checkboxRight: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
        },

         /**
         * Name property
         */
        valueKey: {
            type: String,
            value: '',
            reflectToAttribute: true
        },

        /**
         * Sets the label of the group leave empty for no label
         * @default ""
         */
        labelKey: {
            type: String,
            value: "",
            reflectToAttribute: true
        },



    },


    _dataChanged: function() {
        if (this.data && this.data.length > 0) {
            //do nothing for now.
        }
    },

    /**
     * Returns an array of all items.
     *
     * @property items
     * @type array
     */
    get items() {
        return Polymer.dom(this.root).querySelectorAll('t-checkbox');
    },

    //ensure checkbox checked state and iron selector state is maintained properly
    _onSelectedItemChange: function(newVal, oldVal) {
        if (!newVal || !this.items)
            return;

        if (newVal.indexOf('all') != -1) {
            newVal = ['all']; //maintain only 'All' if present other values accidentally
            
        }

        this.items.forEach(function(elem, elemIndex) {
            var elemValue = elem.getAttribute('name');

            var isPresent = false;
            var atIndex = -1;
            newVal.forEach(function(val, valIndex) {
                if (!isPresent) {
                    isPresent = val.toLowerCase() == elemValue.toLowerCase();
                    if (isPresent) {
                        atIndex = valIndex;
                    }
                }
            }.bind(this));

            if (isPresent) {
                if (!elem.checked) {
                    elem.checked = true;
                }
            } else {
                if (elem.checked) {
                    elem.checked = false;
                }
            }
        }.bind(this));

        //this._handleAllOption(newVal);
    },

    _getValue: function(item){
        if(this.valueKey){
            return item[this.valueKey];
        }
        else{
            return item;
        }
    },

     _getLabel: function(item){
        if(this.labelKey){
            return item[this.labelKey];
        }
        else{
            return item;
        }
    },

    // _handleAllOption: function(changeVal) {
    //     if (changeVal && this.items) {
    //         if (changeVal.indexOf('All') != -1) {
    //             for (var i = 1; i < this.items.length; i++) { //start from '1' assuming 'All' is at '0' index
    //                 this.items[i].checked = false;
    //             }
    //         } else {
    //             this.items[0].checked = false;
    //         }
    //     }
    // },

    _onCheckedChange: function() {

        var val = Polymer.dom(arguments[0]).rootTarget.getAttribute('name');
        //this.selectedValues = this.selectedValues ||[];
        if (Polymer.dom(arguments[0]).rootTarget.checked) {
            if (this.selectedValues.indexOf(val) == -1)
                this.selectedValues.push(val); //not using polymer array functions to avoid loop between _onCheckedChange and _onSelectedItemChange                
        } else {
            if (this.selectedValues.indexOf(val) != -1)
                this.selectedValues.splice(this.selectedValues.indexOf(val), 1); //not using polymer array functions to avoid loop between _onCheckedChange and _onSelectedItemChange                
        }


        //this._handleAllOption([val]);
    },

    validate: function() {
        if (this.required && this.selectedValues.length == 0) {
            this.classList.add('no-value');
            return false;
        }
        this.classList.remove('no-value');
        return true;
    },
});
</script>
